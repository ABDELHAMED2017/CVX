#!/bin/sh

# Version number
MYVERSION=1.1

# Key directories
SRC=`pwd | sed 's@/doc$@@'`
svn update $SRC
SVN=`svn info | grep '^Repository Root: ' | sed 's/^Repository Root: *//'`

# Key subdirectories / sub-repositories
DST=$SRC/WWW
CPY=$SRC/tmp
CVX=$CPY/cvx
TEX=$CPY/doc
TRU=$SVN/trunk
EXA=$SVN/examples
EXC=$CVX/examples
EXD=$DST/examples
DOC=$SVN/doc
TAR=$DST/cvx.tar.gz
ZIP=$DST/cvx.zip

# Build number
MYBUILD=`svn info $TRU | grep "^Last Changed Rev" | sed "s/[^0-9]*//"`
MYTDATE=`date +"%B %Y"`
MYDATE=`date`;
SEDSTR="s@___VERSION___@$MYVERSION@;s@___BUILD___@$MYBUILD@;s@___TDATE___@$MYTDATE@;s@___DATE___@$MYDATE@"
TEXSED="s@cvxver{...@cvxver{$MYVERSION@;s@cvxbuild{...@cvxbuild{$MYBUILD@"

/bin/echo -n Preparing work and staging directories...
rm -rf $DST $CPY
mkdir -p $DST $CPY
/bin/echo done.

/bin/echo -n Retrieving latest sources...
svn export $TRU $CVX >/dev/null
svn export $EXA $EXC >/dev/null
svn export $EXA $EXD >/dev/null
svn export $DOC $TEX >/dev/null
/bin/echo done.
# Insert version information into the version file and docs
cd $CVX
sed "$SEDSTR" cvx_version.m > cvx_version.m.new
mv -f cvx_version.m.new cvx_version.m
cd $TEX
sed "$TEXSED" cvx_usrguide.tex > cvx_usrguide.tex.new
mv -f cvx_usrguide.tex.new cvx_usrguide.tex

/bin/echo -n Compiling the documentation...
latex        cvx_usrguide >/dev/null </dev/null
latex        cvx_usrguide >/dev/null </dev/null
bibtex       cvx_usrguide >/dev/null
makeindex -q cvx_usrguide >/dev/null
latex        cvx_usrguide >/dev/null </dev/null
latex        cvx_usrguide >/dev/null </dev/null
dvips -q     cvx_usrguide >/dev/null
ps2pdf       cvx_usrguide.ps
MYPDF=`du -h cvx_usrguide.pdf | sed 's@\([0-9.]*.\).*@\1B@'`
SEDSTR="$SEDSTR;s@___PDF___@$MYPDF@"
cp cvx_usrguide.pdf $CVX
cp cvx_usrguide.pdf $DST
cd $EXC
sed "$SEDSTR;s@menu{MENU}{index.html}@@" index.jemdoc > index.jemdoc.new
mv -f index.jemdoc.new index.jemdoc
cp -f $TEX/*.css $EXC
jemdoc index.jemdoc
/bin/echo done.

/bin/echo -n Creating the archives...
cd $CPY
chmod -fR a+r,gu+w cvx
find cvx -type d -exec chmod g+s {} \;
tar cfz $TAR cvx >/dev/null
zip -r -9 $ZIP cvx >/dev/null
MYZIP=`du -h $ZIP | sed 's@\([0-9.]*.\).*@\1B@'`
MYTAR=`du -h $TAR | sed 's@\([0-9.]*.\).*@\1B@'`
SEDSTR="$SEDSTR;;s@___ZIP___@$MYZIP@;s@___TAR___@$MYTAR@;s@___PDF___@$MYPDF@"
/bin/echo done.

/bin/echo -n Updating the web pages...
sed "$SEDSTR" $TEX/citing.jemdoc   > $DST/citing.jemdoc
sed "$SEDSTR" $TEX/contact.jemdoc  > $DST/contact.jemdoc
sed "$SEDSTR" $TEX/download.jemdoc > $DST/download.jemdoc
sed "$SEDSTR" $TEX/history.jemdoc  > $DST/history.jemdoc
sed "$SEDSTR" $TEX/index.jemdoc    > $DST/index.jemdoc
sed "$SEDSTR" $TEX/license.jemdoc  > $DST/license.jemdoc
sed "$SEDSTR" $EXD/index.jemdoc    > $EXD/index.jemdoc.new
mv -f $EXD/index.jemdoc.new $EXD/index.jemdoc
cp -f $TEX/MENU $TEX/*.{conf,css,png,gif} $DST
cp -f $TEX/*.css $EXD
cd $DST
jemdoc -c jemdoc.conf *.jemdoc
cd $EXD
jemdoc -c $DST/jemdoc.conf index.jemdoc
/bin/echo done.

/bin/echo -n Cleaning up...
chmod -fR a+r,ug+w $DST
rm -rf $CPY
/bin/echo done.
/bin/echo Staging directory $DST completed.

