#!/bin/sh

# Version number
MYVERSION=1.1
MYDATE=`date`
MYTDATE=`date +"%B %Y"`
MYBUILD=`svn info $SVNBASE | grep ^Revision | sed "s/[^0-9]*//"`
MYZIP=`du --si $DSTDIR/cvx.zip | sed 's@\s.*@@'`
MYTAR=`du --si $DSTDIR/cvx.tar.gz | sed 's@\s.*@@'`
MYPDF=`du --si $DSTDIR/cvx_usrguide.pdf | sed 's@\s.*@@'`
SEDSTR="s@___VERSION___@$MYVERSION@;s@___BUILD___@$MYBUILD@;s@___TDATE___@$MYTDATE@;s@___DATE___@$MYDATE@;s@___ZIP___@$MYZIP@;s@___TAR___@$MYTAR@;s@___PDF___@$MYPDF@"
TEXSED="s@cvxver{...@cvxver{$MYVERSION@;s@cvxbuild{...@cvxbuild{$MYBUILD@"

# Key directories
SRCBASE=/home/boyd/src
CPYDIR=$SRCBASE/cvx.dist
SVNBASE=file://$SRCBASE/svn/cvx
SOURCE=$SVNBASE/trunk
EXAMPLES=$SVNBASE/examples
DOC=$SVNBASE/doc
DSTDIR=/home/boyd/WWW/cvx

# Grab a clean copy of the current version
rm -rf $CPYDIR
mkdir $CPYDIR
svn export $SOURCE   $CPYDIR/cvx
svn export $EXAMPLES $CPYDIR/cvx/examples
svn export $DOC      $CPYDIR/doc

# Insert version information into the version file and docs
cd $CPYDIR/cvx
sed "$SEDSTR" cvx_version.m > cvx_version.m.new
mv -f cvx_version.m.new cvx_version.m
cd $CPYDIR/doc
sed "$TEXSED" cvx_usrguide.tex > cvx_usrguide.tex.new
mf -f cvx_usrguide.tex.new cvx_usrguide.tex

# Compile the documentation
latex  cvx_usrguide
latex  cvx_usrguide
bibtex cvx_usrguide
makeindex cvx_usrguide
latex  cvx_usrguide
latex  cvx_usrguide
latex  cvx_usrguide
dvips  cvx_usrguide
ps2pdf cvx_usrguide.ps
cp cvx_usrguide.pdf $CPYDIR/cvx

# Set the permissions
chgrp -fR research $CPYDIR/cvx 
chmod -fR a+r,gu+w $CPYDIR/cvx
find $CPYDIR/cvx -type d -exec chmod g+s {} \;

# Create the archives
cd $CPYDIR
rm $DSTDIR/cvx.{tar.gz,zip}
tar cvfz $DSTDIR/cvx.tar.gz cvx
zip -r -9 $DSTDIR/cvx.zip cvx
cd cvx
tar cvf $DSTDIR/cvx-examples.tar examples

# Copy the documentation over and extract examples
cd $DSTDIR
cp $CPYDIR/doc/cvx_usrguide.pdf .
rm -rf examples
tar xvf cvx-examples.tar
rm -rf cvx-examples.tar

# Update the index file and history file
MYDATE=`date`
MYTDATE=`date +"%B %Y"`
MYBUILD=`svn info $SVNBASE | grep ^Revision | sed "s/[^0-9]*//"`
MYZIP=`du --si $DSTDIR/cvx.zip | sed 's@\s.*@@'`
MYTAR=`du --si $DSTDIR/cvx.tar.gz | sed 's@\s.*@@'`
MYPDF=`du --si $DSTDIR/cvx_usrguide.pdf | sed 's@\s.*@@'`
SEDSTR="s@___VERSION___@$MYVERSION@;s@___BUILD___@$MYBUILD@;s@___TDATE___@$MYTDATE@;s@___DATE___@$MYDATE@;s@___ZIP___@$MYZIP@;s@___TAR___@$MYTAR@;s@___PDF___@$MYPDF@"
sed "$SEDSTR" $CPYDIR/doc/index.html > $DSTDIR/index.html
sed "$SEDSTR" $CPYDIR/doc/history.html > $DSTDIR/history.html
cp -f $CPYDIR/doc/*.{gif,png} $DSTDIR

# Set the permissons at the destination
chgrp -fR research $DSTDIR
chmod -fR a+r,ug+w $DSTDIR

# Remove the working directory
cd $SRCBASE
rm -rf $CPYDIR

